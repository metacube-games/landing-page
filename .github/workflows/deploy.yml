name: Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          debug: true
          script: |
            set -e  # Exit on error

            echo "=== Deployment Started ==="

            # Install Bun if not present
            if ! command -v bun &> /dev/null; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            else
              echo "Bun already installed"
            fi

            # Load Bun environment
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            # Verify Bun installation
            echo "Bun version: $(bun --version)"

            # Run deploy script (build the app)
            echo "Running deployment script..."
            /home/github/deploy.sh

            # Stop and delete the old PM2 process
            echo "Stopping old PM2 process..."
            pm2 delete landing-page || echo "No existing process to delete"

            # Start PM2 with ecosystem config
            echo "Starting app with Bun using PM2..."
            cd /home/github/landing-page
            pm2 start ecosystem.config.js
            pm2 save

            # Check if the process is running
            echo "Checking application status..."
            sleep 5
            pm2 list

            # Show recent logs to verify it's working
            echo "=== Recent Application Logs ==="
            pm2 logs landing-page --lines 30 --nostream || echo "Could not fetch logs"

            echo "=== Deployment Completed ==="
