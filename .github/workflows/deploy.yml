name: Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 30m
          debug: true
          script: |
            echo "=== Deployment Started ==="

            # Set variables
            APP_DIR="/home/github/landing-page"

            # Check disk space before cleanup
            echo "Disk space before cleanup:"
            df -h

            # Cleanup to free disk space (no set -e here - cleanup can fail safely)
            echo "=== Cleaning up disk space ==="
            pm2 flush 2>/dev/null || true
            rm -rf "$APP_DIR/.next" 2>/dev/null || true
            rm -rf "$APP_DIR/node_modules/.cache" 2>/dev/null || true
            rm -rf ~/.bun/install/cache/* 2>/dev/null || true
            rm -rf ~/.npm 2>/dev/null || true
            rm -rf ~/.yarn/cache 2>/dev/null || true
            rm -rf ~/.cache 2>/dev/null || true
            rm -f "$APP_DIR/.git/index.lock" 2>/dev/null || true

            echo "Disk space after cleanup:"
            df -h
            echo "=== Cleanup Complete ==="

            # Enable strict error handling AFTER cleanup
            set -e

            # Install Bun if not present
            if ! command -v bun &> /dev/null; then
              echo "Installing Bun..."
              curl -fsSL https://bun.sh/install | bash
              export BUN_INSTALL="$HOME/.bun"
              export PATH="$BUN_INSTALL/bin:$PATH"
            fi

            # Load Bun environment
            export BUN_INSTALL="$HOME/.bun"
            export PATH="$BUN_INSTALL/bin:$PATH"

            echo "Bun version: $(bun --version)"

            # Run deploy script (git pull + build)
            echo "Running deployment script..."
            if [ -f /home/github/deploy.sh ]; then
              /home/github/deploy.sh
            else
              echo "ERROR: /home/github/deploy.sh not found"
              echo "Build step required - cannot deploy without building"
              exit 1
            fi

            # Stop old PM2 process
            echo "Stopping old PM2 process..."
            pm2 delete landing-page 2>/dev/null || true

            # Verify ecosystem config exists
            if [ ! -f "$APP_DIR/ecosystem.config.js" ]; then
              echo "ERROR: ecosystem.config.js not found in $APP_DIR"
              exit 1
            fi

            # Start PM2 with ecosystem config
            echo "Starting app with PM2..."
            cd "$APP_DIR"
            pm2 start ecosystem.config.js
            pm2 save

            # Verify app is running
            sleep 3
            if pm2 describe landing-page > /dev/null 2>&1; then
              echo "âœ“ App started successfully"
              pm2 list
              pm2 logs landing-page --lines 20 --nostream || true
            else
              echo "ERROR: App failed to start"
              exit 1
            fi

            echo "=== Deployment Completed ==="
