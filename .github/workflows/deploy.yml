name: Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Install nvm if not present
            if [ ! -d "$HOME/.nvm" ]; then
              curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
            fi

            # Load nvm
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            # Install and use Node.js 20.9.0
            nvm install 20.9.0
            nvm use 20.9.0

            # Verify Node version
            echo "Node version: $(node -v)"
            echo "Npm version: $(npm -v)"

            # Run deploy script
            /home/github/deploy.sh

            # Check if the process is running
            echo "Checking application status..."
            ps aux | grep -i next || echo "Next.js process not found"
